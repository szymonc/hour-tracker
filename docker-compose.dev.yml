# Development override: hot-reload for backend and frontend.
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build
#
# - Backend: source mounted, runs `nest start --watch` (NestJS hot reload).
# - Frontend: source mounted, runs `ng serve` with polling (Angular HMR).
# - Postgres: unchanged.

services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    command: npm run start:dev
    volumes:
      - ./backend:/app
      # Keep container node_modules; host mount would overwrite without this
      - api_node_modules:/app/node_modules
    environment:
      NODE_ENV: development

  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    command: npx ng serve --host 0.0.0.0 --port 4200 --poll 2000
    volumes:
      - ./frontend:/app
      - web_node_modules:/app/node_modules
    ports:
      - "${WEB_PORT:-4200}:4200"
    environment:
      NODE_ENV: development
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4200"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  api_node_modules:
  web_node_modules:
